# 什么是分布式
分布式其实就是**将相同或相关的程序运行在多台计算机上，从而实现特定目标的一种计算方式**。

从这个定义来看，数据并行、任务并行其实都可以算作是分布式的一种形态。从这些计算方式的演变中不难看出，产生分布式的最主要驱动力量，是我们对于性能、可用性及可扩展性的不懈追求。

# RPC(远程调用)
分布式的本质就是**多进程协作**，共同完成任务。要协作，自然免不了通信。那么，多个进程之间是如何通信的呢？
![](https://pic.imgdb.cn/item/66a06608d9c307b7e9d0c7d9.png)
本地调用通常指的是，**进程内函数之间的相互调用**；而远程调用，是**进程间函数的相互调用**，是一种进程间通信模式。

在分布式领域中，**一个系统由很多服务组成，不同的服务由各自的进程单独负责**。因此，远程调用在分布式通信中尤为重要。

根据进程是否部署在同一台机器上，远程调用可以分为如下两类：

- 本地过程调用（Local Procedure Call，LPC），是指同一台机器上运行的不同进程之间的互相通信，即在多进程操作系统中，运行的不同进程之间可以通过LPC进行函数调用。
- **远程过程调用（Remote Procedure Call，RPC）**，是指不同机器上运行的进程之间的相互通信，**某一机器上运行的进程在不知道底层通信细节的情况下，就像访问本地服务一样，去调用远程机器上的服务**。


![](https://pic.imgdb.cn/item/66a06837d9c307b7e9d2c0b1.png)
RPC的目的，其实就是要将第2到第8步的几个过程封装起来，让用户看不到这些细节。从用户的角度看，订单系统的进程只是做了一次普通的本地调用，然后就得到了结果。

也就是说，订单系统进程并不需要知道底层是如何传输的，**在用户眼里，远程过程调用和调用一次本地服务没什么不同。这，就是RPC的核心。**

另外，RPC是一种抽象的 网络服务协议框架（即定义网络中各个服务如何通信的规则），是有多种实现的。

# CAP理论
- **C代表Consistency，一致性，是指所有节点在同一时刻的数据是相同的**，即更新操作执行结束并响应用户完成后，所有节点存储的数据会保持相同。
    > 电商系统中，A、B、C中存储的该电吹风的数量应该是20+10+30=60。假设，现在有一个北京用户买走一个电吹风，服务器A会更新数据为60-1=59，与此同时要求B和C也更新为59，以保证在同一时刻，无论访问A、B、C中的哪个服务器，得到的数据均是59。
- **A代表Availability，可用性，是指系统提供的服务一直处于可用状态，对于用户的请求可即时响应。**
  > 在电商系统中，用户在任一时刻向A、B、C中的任一服务器发出请求时，均可得到即时响应，比如查询商品信息等。
- **P代表Partition Tolerance，分区容错性，是指在分布式系统遇到网络分区的情况下，仍然可以响应用户的请求。** 网络分区是指因为网络故障导致网络不连通，不同节点分布在不同的子网络中，各个子网络内网络正常。在实际场景中，网络环境不可能百分之百不出故障，比如网络拥塞、网卡故障等，会导致网络故障或不通，**从而导致节点之间无法通信，或者集群中节点被划分为多个分区，分区中的节点之间可通信，分区间不可通信。**
这种由网络故障导致的集群分区情况，通常被称为“网络分区”。
    > 在电商系统中，假设C与A和B的网络都不通了，A和B是相通的。也就是说，形成了两个分区{A, B}和{C}，在这种情况下，系统仍能响应用户请求。

![](https://pic.imgdb.cn/item/66a06fd3d9c307b7e9da22b0.png)
CAP理论指的就是，**在分布式系统中C、A、P这三个特征不能同时满足，只能满足其中两个**。

在分布式系统中，网络分区不可避免，因此分区容错性P必须满足。
- 保证一致性C，牺牲可用性A
  ![](https://pic.imgdb.cn/item/66a0784ad9c307b7e9e1be15.png)
  > 例如zookeeper处理网络中的写请求：当出现网络分区时，如果其中一个分区的节点数大于集群总节点数的一半，那么这个分区可以再选出一个Leader，仍然对用户提供服务，但在选出Leader之前，不能正常为用户提供服务；如果形成的分区中，没有一个分区的节点数大于集群总节点数的一半，那么系统不能正常为用户提供服务，必须待网络恢复后，才能正常提供服务。
- 保证可用性A，牺牲一致性C
  ![](https://pic.imgdb.cn/item/66a07872d9c307b7e9e1e211.png)
  > 以电商购物系统为例，如下图所示，某电吹风在北京仓库有20个，在杭州仓库有10个，在上海仓库有30个。初始时，北京、杭州、上海分别建立的服务器{A, B, C}存储该电吹风的数量均为60个。
  >
  > 假如，上海的网络出现了问题，与北京和杭州网络均不通，此时北京的用户通过北京服务器A下单购买了一个电吹风，电吹风数量减少到59，并且同步给了杭州服务器B。也就是说，现在用户的查询请求如果是提交到服务器A和B，那么查询到的数量为59。但通过上海服务器C进行查询的结果，却是60。
  > 
  > 当然，待网络恢复后，服务器A和B的数据会同步到C，C更新数据为59，最终三台服务器数据保持一致，用户刷新一下查询界面或重新提交一下查询，就可以得到最新的数据。而对用户来说，他们并不会感知到前后数据的差异，到底是因为其他用户购买导致的，还是因为网络故障导致数据不同步而产生的。
  ![](https://pic.imgdb.cn/item/66a07a55d9c307b7e9e38877.png)
  为什么上海服务器不能等网络恢复后，再响应用户请求呢？可以想象一下，如果用户提交一个查询请求，需要等上几分钟、几小时才能得到反馈，那么用户早已离去了。

# Paxos算法


# 参考
- 分布式技术原理与算法解析-极客时间
- 分布式技术原理与实战45讲-极客时间
